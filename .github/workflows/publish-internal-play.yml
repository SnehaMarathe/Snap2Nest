name: Publish to Play (Internal)

on:
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Install Gradle because the wrapper JAR is not committed.
      - name: Install Gradle (system)
        run: |
          sudo apt-get update
          sudo apt-get install -y gradle

      - name: Generate Gradle Wrapper if missing
        run: |
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            gradle wrapper --gradle-version 8.9
          fi

      - name: Grant execute permission for Gradle
        run: chmod +x ./gradlew

      - name: Decode upload keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/upload-keystore.jks

      - name: Build Release App Bundle (AAB)
        env:
          SIGNING_KEYSTORE_PATH: app/upload-keystore.jks
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew bundleRelease

      - name: Write Play service account JSON
        run: |
          echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}" > play-service-account.json

      # Requires:
      # - Play Console app already created at least once
      # - Service account added in Play Console > API access
      # - secrets.PLAY_SERVICE_ACCOUNT_JSON set
      - name: Upload to Internal track
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: play-service-account.json
          packageName: com.snehamarathe.snap2nest
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: draft
